//Backpropagation funcionando

#include<stdio.h>
#include<stdlib.h>
#include<math.h>

main()
{
    int i, j, l, cs, n=0, m=0;
    float erro, v, er;
    float I0[4],O0[4],I1[4],O1[4],I2[2],O2[2];
    float w1[4][4] ,w2[4][2];
    float nw1[4][4],nw2[4][2];
    float vw1[4][4],vw2[4][2];
    float d2,d1[3];

    float E1[4]={0.0,0.0,1.0,1.0};
    float E2[4]={0.0,1.0,0.0,1.0};
    float TG[4]={0.0,1.0,1.0,0.0};

    //Gerar valores randomicos

     w1[1][1]=(rand()/32767.0)*4.0-2.0;
    vw1[1][1]=0.0;
     w1[2][1]=(rand()/32767.0)*4.0-2.0;
    vw1[2][1]=0.0;
     w1[3][1]=(rand()/32767.0)*4.0-2.0;
    vw1[3][1]=0.0;

     w1[1][2]=(rand()/32767.0)*4.0-2.0;
    vw1[1][2]=0.0;
     w1[2][2]=(rand()/32767.0)*4.0-2.0;
    vw1[2][2]=0.0;
     w1[3][2]=(rand()/32767.0)*4.0-2.0;
    vw1[3][2]=0.0;

     w2[1][1]=(rand()/32767.0)*4.0-2.0;
    vw2[1][1]=0.0;
     w2[2][1]=(rand()/32767.0)*4.0-2.0;
    vw2[2][1]=0.0;
     w2[3][1]=(rand()/32767.0)*4.0-2.0;
    vw2[3][1]=0.0;

    do{
        erro=0.0;
        for(n=0;n<=100;n++){

            cs=rand()%4;

            I0[1]=E1[cs];
            I0[2]=E2[cs];
            I0[3]=1.0;

            O0[1]=I0[1];
            O0[2]=I0[2];
            O0[3]=I0[3];

            I1[1]=O0[1]*w1[1][1]+O0[2]*w1[2][1]+O0[3]*w1[3][1];
            I1[2]=O0[1]*w1[1][2]+O0[2]*w1[2][2]+O0[3]*w1[3][2];
            I1[3]=1.0;

            O1[1]=1.0/(1.0+exp(-I1[1]));
            O1[2]=1.0/(1.0+exp(-I1[2]));
            O1[3]=I1[3];



            I2[1]=O1[1]*w2[1][1]+O1[2]*w2[2][1]+O1[3]*w2[3][1];
            O2[1]=1.0/(1.0+exp(-I2[1]));

            //----------backpropagation--------------------------------

            d2=(TG[cs]-O2[1])*O2[1]*(1.0-O2[1]);
            d1[1]=O1[1]*(1.0-O1[1])*d2*w2[1][1];
            d1[2]=O1[2]*(1.0-O1[2])*d2*w2[2][1];

            nw2[1][1]= w2[1][1]+0.5*d2*O1[1]+0.5*vw2[1][1];
            vw2[1][1]=nw2[1][1]-w2[1][1];
             w2[1][1]=nw2[1][1];

            nw2[2][1]= w2[2][1]+0.5*d2*O1[2]+0.5*vw2[2][1];
            vw2[2][1]=nw2[2][1]-w2[2][1];
             w2[2][1]=nw2[2][1];

            nw2[3][1]= w2[3][1]+0.5*d2*O1[3]+0.5*vw2[3][1];
            vw2[3][1]=nw2[3][1]-w2[3][1];
             w2[3][1]=nw2[3][1];
            //-------------------------------------------------
            nw1[1][1]= w1[1][1]+0.5*d1[1]*O0[1]+0.5*vw1[1][1];
            vw1[1][1]=nw1[1][1]-w1[1][1];
             w1[1][1]=nw1[1][1];

            nw1[2][1]= w1[2][1]+0.5*d1[1]*O0[2]+0.5*vw1[2][1];
            vw1[2][1]=nw1[2][1]-w1[2][1];
             w1[2][1]=nw1[2][1];

            nw1[3][1]= w1[3][1]+0.5*d1[1]*O0[3]+0.5*vw1[3][1];
            vw1[3][1]=nw1[3][1]-w1[3][1];
             w1[3][1]=nw1[3][1];

            //-------------------------------------------------

            nw1[1][2]= w1[1][2]+0.5*d1[2]*O0[1]+0.5*vw1[1][2];
            vw1[1][2]=nw1[1][2]-w1[1][2];
             w1[1][2]=nw1[1][2];

            nw1[2][2]= w1[2][2]+0.5*d1[2]*O0[2]+0.5*vw1[2][2];
            vw1[2][2]=nw1[2][2]-w1[2][2];
             w1[2][2]=nw1[2][2];

            nw1[3][2]= w1[3][2]+0.5*d1[2]*O0[3]+0.5*vw1[3][2];
            vw1[3][2]=nw1[3][2]-w1[3][2];
             w1[3][2]=nw1[3][2];

             //Fim Backpropagation-----------------------------

            erro+= (TG[cs]-O2[1])*(TG[cs]-O2[1]);
        }//n
        m++;
        erro=erro/100.0;
        printf("%d %f \n",m,erro);
    }while(erro>0.0001);

        for(j=1;j<3;j++){
                for(i=1;i<4;i++){
                    printf("w1[%d][%d]=%f; \n", i,j,w1[i][j]);
                }
            }

        for(l=1;l<2;l++){
            for(j=1;j<4;j++){
                printf("w2[%d][%d]=%f; \n", j,l,w2[j][l]);
            }
        }
}
